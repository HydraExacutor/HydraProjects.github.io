<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trombone Champ Save Editor</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
  body {
    font-family: 'Roboto', sans-serif;
    background: #121212;
    color: #eee;
    margin: 0; padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  header {
    margin: 20px 0 10px;
    font-size: 2rem;
    font-weight: 700;
    color: #76c7c0;
  }
  main {
    background: #222;
    padding: 25px 30px;
    border-radius: 10px;
    max-width: 460px;
    width: 90vw;
    box-shadow: 0 0 12px #76c7c0aa;
  }
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
  }
  input[type="file"] {
    width: 100%;
    margin-bottom: 20px;
    background: #333;
    color: #ccc;
    padding: 8px;
    border-radius: 5px;
    border: none;
  }
  .toggles {
    display: flex;
    justify-content: space-around;
    margin-bottom: 25px;
  }
  .toggles label {
    cursor: pointer;
  }
  .toggles input[type="checkbox"] {
    margin-right: 8px;
    width: 18px;
    height: 18px;
  }
  .slider-container {
    margin-bottom: 20px;
  }
  .slider-label {
    margin-bottom: 6px;
    font-weight: 600;
  }
  input[type="range"] {
    width: 100%;
    cursor: pointer;
  }
  input[type="number"] {
    width: 100%;
    padding: 6px 10px;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    margin-top: 6px;
    background: #333;
    color: #eee;
  }
  button {
    background: #76c7c0;
    border: none;
    padding: 12px 20px;
    width: 100%;
    color: #121212;
    font-weight: 700;
    font-size: 1.1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.25s ease-in-out;
  }
  button:disabled {
    background: #444;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background: #5aa9a4;
  }
  footer {
    margin-top: 30px;
    font-size: 0.9rem;
    color: #888;
  }
  .instructions-link {
    color: #76c7c0;
    text-decoration: underline;
    cursor: pointer;
  }
</style>
</head>
<body>
<header>Trombone Champ Save Editor</header>
<main>
  <form id="saveForm">
    <label for="fileMain">Upload <code>tchamp_savev100_0.dat</code> file:</label>
    <input type="file" id="fileMain" accept=".dat" required />

    <label for="fileBackup">Upload <code>tchamp_savev100_0_BACKUP.dat</code> file:</label>
    <input type="file" id="fileBackup" accept=".dat" required />

    <div class="toggles">
      <label><input type="checkbox" id="editToots" checked /> Edit Toots</label>
      <label><input type="checkbox" id="editTurds" /> Edit Turds</label>
    </div>

    <div class="slider-container">
      <label class="slider-label" for="tootSlider">Number of Toots / Turds:</label>
      <input type="range" id="tootSlider" min="0" max="65535" value="0" />
      <input type="number" id="tootNumber" min="0" max="65535" value="0" />
    </div>

    <button type="submit" id="downloadBtn" disabled>Download Edited Save Files</button>
  </form>

  <p style="margin-top:20px; text-align:center;">
    <span class="instructions-link" id="instructionsLink">Where to find your .dat files & Instructions</span>
  </p>
</main>
<footer>Â© Hydra Projects</footer>

<script>
  // Elements
  const fileMain = document.getElementById('fileMain');
  const fileBackup = document.getElementById('fileBackup');
  const editToots = document.getElementById('editToots');
  const editTurds = document.getElementById('editTurds');
  const tootSlider = document.getElementById('tootSlider');
  const tootNumber = document.getElementById('tootNumber');
  const downloadBtn = document.getElementById('downloadBtn');
  const instructionsLink = document.getElementById('instructionsLink');

  // Sync slider and number input
  tootSlider.addEventListener('input', () => {
    tootNumber.value = tootSlider.value;
  });
  tootNumber.addEventListener('input', () => {
    let val = parseInt(tootNumber.value);
    if (isNaN(val) || val < 0) val = 0;
    if (val > 65535) val = 65535;
    tootNumber.value = val;
    tootSlider.value = val;
  });

  // Enable download button only if both files are uploaded
  function checkFiles() {
    downloadBtn.disabled = !(fileMain.files.length > 0 && fileBackup.files.length > 0);
  }
  fileMain.addEventListener('change', checkFiles);
  fileBackup.addEventListener('change', checkFiles);

  // Helper: convert number to 4-byte little endian Uint8Array
  function toLittleEndian4Bytes(num) {
    const arr = new Uint8Array(4);
    arr[0] = num & 0xff;
    arr[1] = (num >> 8) & 0xff;
    arr[2] = (num >> 16) & 0xff;
    arr[3] = (num >> 24) & 0xff;
    return arr;
  }

  // Search & replace function in Uint8Array for 4-byte little endian numbers
  // This assumes you know the current value to find (also 4 bytes LE)
  function findAndReplace(buffer, currentNum, newNum) {
    const arr = new Uint8Array(buffer);
    const currentBytes = toLittleEndian4Bytes(currentNum);
    const newBytes = toLittleEndian4Bytes(newNum);

    for (let i = 0; i < arr.length - 3; i++) {
      if (
        arr[i] === currentBytes[0] &&
        arr[i+1] === currentBytes[1] &&
        arr[i+2] === currentBytes[2] &&
        arr[i+3] === currentBytes[3]
      ) {
        // Replace bytes
        arr[i] = newBytes[0];
        arr[i+1] = newBytes[1];
        arr[i+2] = newBytes[2];
        arr[i+3] = newBytes[3];
        // Assume only first occurrence, break here
        break;
      }
    }
    return arr.buffer;
  }

  // Read file as ArrayBuffer promise
  function readFileAsArrayBuffer(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = e => reject(e);
      reader.readAsArrayBuffer(file);
    });
  }

  // Main form submit handler
  document.getElementById('saveForm').addEventListener('submit', async e => {
    e.preventDefault();

    const tootVal = parseInt(tootNumber.value);
    if (isNaN(tootVal) || tootVal < 0) {
      alert('Please enter a valid number of toots/turds.');
      return;
    }

    if (!fileMain.files[0] || !fileBackup.files[0]) {
      alert('Please upload both save files.');
      return;
    }

    // Read both files
    try {
      let mainBuffer = await readFileAsArrayBuffer(fileMain.files[0]);
      let backupBuffer = await readFileAsArrayBuffer(fileBackup.files[0]);

      // TODO: You need to know current values in save files for toots and turds to find & replace them correctly.
      // For this example, let's assume the user entered the current value as 0 (you can improve this by reading it first)

      // For demo: We'll let user enter current toot and turd values? But you wanted just to enter new value?  
      // So better approach: We ask user current number of toots and turds (add two inputs?), then find those and replace with new number.

      // For now: We just do no find & replace, just replace first 4 bytes after a known offset? That is tricky without exact knowledge.

      // So you must tell me exact offset or how to find current toot/turd values in the save files to properly replace.

      alert('Functionality to find and replace the current toot/turd values needs to be implemented based on save file structure.');

      // This is just a placeholder to trigger download of the original files unchanged
      // Download files:
      downloadEditedFile(mainBuffer, fileMain.files[0].name);
      downloadEditedFile(backupBuffer, fileBackup.files[0].name);

    } catch (err) {
      alert('Error reading files: ' + err);
    }
  });

  function downloadEditedFile(buffer, filename) {
    const blob = new Blob([buffer], {type: 'application/octet-stream'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    link.remove();
  }

  // Instructions link
  instructionsLink.addEventListener('click', () => {
    window.location.href = 'instructions.html';
  });
</script>
</body>
</html>
