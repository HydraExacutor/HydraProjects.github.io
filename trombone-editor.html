<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trombone Champ Save Editor</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: auto;
    padding: 1rem;
    background: #f9f9f9;
  }
  h1, h2 {
    text-align: center;
  }
  .instructions {
    margin-bottom: 2rem;
    padding: 1rem;
    background: #f0f0f0;
    border-radius: 8px;
  }
  label {
    display: block;
    margin-top: 1rem;
    font-weight: bold;
  }
  input[type="file"],
  input[type="number"] {
    width: 100%;
    padding: 0.5rem;
    margin-top: 0.3rem;
  }
  button {
    margin-top: 1.5rem;
    padding: 0.7rem 1.2rem;
    font-size: 1rem;
    cursor: pointer;
  }
  .output {
    margin-top: 1rem;
    padding: 1rem;
    background: #e0ffe0;
    border: 1px solid #8bc34a;
    border-radius: 6px;
  }
  .download-links a {
    display: block;
    margin-top: 0.5rem;
  }
</style>
</head>
<body>

<h1>Trombone Champ Save Editor</h1>

<div class="instructions">
  <h2>Where to find your save files (.dat)</h2>
  <p>
    For <strong>Mac</strong>, look here:<br />
    <code>/Users/your-username/Library/Application Support/com.holywowstudios.trombonechamp/</code><br /><br />
    For <strong>Windows</strong>, the files are usually located in:<br />
    <code>C:\Users\your-username\AppData\LocalLow\Holy Wow Studios\Trombone Champ\</code>
  </p>
  <p>
    <a href="instructions.html">Click here for detailed editing instructions</a>
  </p>
</div>

<form id="save-editor-form">
  <label for="main-save-file">Select your <code>tchamp_savev100_0.dat</code> file:</label>
  <input type="file" id="main-save-file" accept=".dat" required />

  <label for="backup-save-file">Select your <code>tchamp_savev100_0_BACKUP.dat</code> file:</label>
  <input type="file" id="backup-save-file" accept=".dat" required />

  <label for="toots-input">Enter new number of <strong>toots</strong>:</label>
  <input type="number" id="toots-input" min="0" max="65535" value="0" required />

  <label for="turds-input">Enter new number of <strong>turds</strong>:</label>
  <input type="number" id="turds-input" min="0" max="65535" value="0" required />

  <button type="submit">Edit Save Files</button>
</form>

<div class="output" id="output-message" style="display:none;">
  <strong>Save files edited successfully!</strong>
  <div class="download-links" id="download-links"></div>
</div>

<script>
  function numberTo2BytesLE(num) {
    const buffer = new ArrayBuffer(2);
    const view = new DataView(buffer);
    view.setUint16(0, num, true);
    return new Uint8Array(buffer);
  }

  function findBytes(haystack, needle) {
    for (let i = 0; i <= haystack.length - needle.length; i++) {
      let found = true;
      for (let j = 0; j < needle.length; j++) {
        if (haystack[i + j] !== needle[j]) {
          found = false;
          break;
        }
      }
      if (found) return i;
    }
    return -1;
  }

  function editFile(data, toots, turds) {
    const encoder = new TextEncoder();
    const tootsKey = encoder.encode('currency_toots');
    const turdsKey = encoder.encode('currency_turds');

    const tootsPos = findBytes(data, tootsKey);
    const turdsPos = findBytes(data, turdsKey);

    if (tootsPos === -1 || turdsPos === -1) {
      return false;
    }

    const tootsValuePos = tootsPos + tootsKey.length + 3;
    const turdsValuePos = turdsPos + turdsKey.length + 3;

    const tootsBytes = numberTo2BytesLE(toots);
    const turdsBytes = numberTo2BytesLE(turds);

    data[tootsValuePos] = tootsBytes[0];
    data[tootsValuePos + 1] = tootsBytes[1];

    data[turdsValuePos] = turdsBytes[0];
    data[turdsValuePos + 1] = turdsBytes[1];

    return true;
  }

  document.getElementById('save-editor-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const mainFileInput = document.getElementById('main-save-file');
    const backupFileInput = document.getElementById('backup-save-file');
    const toots = parseInt(document.getElementById('toots-input').value, 10);
    const turds = parseInt(document.getElementById('turds-input').value, 10);

    if (!mainFileInput.files.length || !backupFileInput.files.length) {
      alert('Please select both save files.');
      return;
    }
    if (isNaN(toots) || toots < 0 || toots > 65535) {
      alert('Please enter a valid number of toots (0 - 65535).');
      return;
    }
    if (isNaN(turds) || turds < 0 || turds > 65535) {
      alert('Please enter a valid number of turds (0 - 65535).');
      return;
    }

    const output = document.getElementById('output-message');
    const downloadLinks = document.getElementById('download-links');
    downloadLinks.innerHTML = '';
    output.style.display = 'none';

    // Helper to process a file and create download link
    function processFile(file, filenameSuffix) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function() {
          const data = new Uint8Array(reader.result);
          const success = editFile(data, toots, turds);
          if (!success) {
            reject('Could not find currency values in ' + file.name);
            return;
          }
          const editedBlob = new Blob([data], { type: 'application/octet-stream' });
          const url = URL.createObjectURL(editedBlob);

          const link = document.createElement('a');
          link.href = url;
          link.download = file.name.replace('.dat', filenameSuffix + '.dat');
          link.textContent = `Download Edited ${file.name}`;
          link.style.display = 'block';

          link.addEventListener('click', () => {
            setTimeout(() => URL.revokeObjectURL(url), 100);
          });

          resolve(link);
        };
        reader.onerror = () => reject('Failed to read file: ' + file.name);
        reader.readAsArrayBuffer(file);
      });
    }

    Promise.all([
      processFile(mainFileInput.files[0], '_edited'),
      processFile(backupFileInput.files[0], '_backup_edited')
    ]).then(links => {
      links.forEach(link => downloadLinks.appendChild(link));
      output.style.display = 'block';
    }).catch(err => {
      alert(err);
    });
  });
</script>

</body>
</html>
